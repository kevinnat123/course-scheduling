{% extends "layout.html" %} {% block content %}
<div class="container-fluid mt-4" id="main-window">
  <div class="card">
    <div class="card-body">
      <button type="button" class="btn btn-primary" onclick="generate_jadwal()">
        Generate
      </button>
      <button
        type="button"
        class="btn btn-success"
        onclick="download_excel_by()"
      >
        Download Excel
      </button>
    </div>
  </div>

  <div class="card">
    <div class="card-body">
      <div class="table-responsive">
        <table
          class="table table-bordered table-stripped table-hover w-100"
          id="table_jadwal"
        >
          <thead class="text-center align-middle text-nowrap">
            <tr>
              <td colspan="2">Mata Kuliah</td>
              <td colspan="2">Dosen</td>
              <td rowspan="2">SKS Akademik</td>
              <td colspan="2">Ruangan</td>
              <td colspan="3">Jadwal</td>
            </tr>
            <tr>
              <td>Kode</td>
              <td>Nama</td>
              <td>Kode</td>
              <td>Nama</td>
              <td>Kode</td>
              <td>Kapasitas</td>
              <td>Hari</td>
              <td>Jam Mulai</td>
              <td>Jam Selesai</td>
            </tr>
          </thead>
          <tbody></tbody>
        </table>
      </div>
    </div>
  </div>
</div>
{% endblock %} {% block script %}
<script>
  const semester_ajaran_depan = "{{ semester_ajaran_depan | safe }}";
  const prodi = "{{ prodi | safe }}";

  $(document).ready(function () {});

  function generate_jadwal(generate_ulang = false) {
    param = {
      regenerate: generate_ulang,
    };
    $.ajax({
      type: "GET",
      url: "/generate_jadwal/generate",
      data: param,
      cache: false,
      beforeSend: () => {
        showLoading();
      },
      complete: () => {
        hideLoading();
      },
      success: async function (res) {
        console.log("res ajax", res);

        if (res.status) export_to_excel("Jadwal_Kuliah");
        else {
          if (res.reason === "exist") {
            Swal.fire({
              icon: "info",
              title: "Jadwal sudah pernah dibuat!",
              text: "Apakah mau buat ulang?",
              showDenyButton: true,
              showCancelButton: false,
              confirmButtonText: "Buat Ulang",
              denyButtonText: "Batal",
            }).then((result) => {
              if (result.isConfirmed) {
                return generate_jadwal(true);
              } else if (result.isDenied) {
                return;
              }
            });
          }
          popUpTimer("error", res.message);
        }
      },
    });
  }

  function download_excel_by() {
    Swal.fire({
      title: "Cetak apa?",
      showDenyButton: true,
      showCancelButton: true,
      confirmButtonText: "Jadwal Kuliah",
      denyButtonText: `Jadwal Ruangan`,
      confirmButtonColor: "#007bff",
      denyButtonColor: "#28a745",
    }).then((result) => {
      if (result.isConfirmed) {
        export_to_excel("Jadwal_Kuliah");
      } else if (result.isDenied) {
        export_to_excel("Jadwal_Ruangan");
      }
    });
  }

  /**
   * @returns {link} - link download document
   */
  async function export_to_excel(downloadBy) {
    console.warn("downloading...");
    let filename = downloadBy + "_Semester-" + semester_ajaran_depan;
    console.log(filename);
    try {
      let params = {
        filename: filename,
        downloadBy: downloadBy.toLowerCase(),
      };

      const data = await $.ajax({
        type: "POST",
        url: "/export/export_to_excel",
        data: JSON.stringify(params),
        contentType: "application/json",
        xhrFields: {
          responseType: "blob",
        },
        beforeSend: () => {
          Swal.fire({
            html: `<p><b>Sedang Membuat File Laporan...</b></p><p style="text-align: center;">Jangan menutup halaman ini!</p>`,
            allowOutsideClick: false,
            allowEnterKey: false,
            allowEscapeKey: false,
            showConfirmButton: false,
            willOpen: (_) => {
              $("#modal_loading").modal("show");
            },
          });
        },
        complete: () => {
          $("#modal_loading").modal("hide");
        },
      });

      Swal.fire({
        title: "Sukses!",
        text: "Berhasil Download Laporan",
        icon: "success",
      });

      const url = URL.createObjectURL(data);
      const link = document.createElement("a");

      link.href = url;
      link.download = filename + ".xlsx";
      document.body.appendChild(link);
      link.click();
      document.body.removeChild(link);
    } catch (error) {
      popUpTimer("error", error.status, error.statusText);
    }
  }

  let jadwal_tab = $("#table_jadwal").DataTable({
    scrollX: true,
    scrollY: "100vh",
    scrollCollapse: true,
    paging: false,
    responsive: true,
    ordering: false,
    info: false,
    ajax: {
      type: "GET",
      url: "/generate_jadwal/tampilkan_jadwal",
      data: function (d) {
        return {
          prodi: prodi ? prodi : null,
        };
      },
      cache: false,
      beforeSend: () => {
        console.log("before");
        showLoading();
      },
      complete: () => {
        hideLoading();
      },
    },
    columns: [
      {
        data: "kode_matkul",
        width: "75px",
        className: "text-start align-middle",
        defaultContent: "",
      },
      {
        data: "nama_matkul",
        width: "300px",
        className: "text-start align-middle",
        defaultContent: "",
      },
      {
        data: "kode_dosen",
        width: "75px",
        className: "text-start align-middle",
        defaultContent: "",
      },
      {
        data: "nama_dosen",
        width: "300px",
        className: "text-start align-middle",
        defaultContent: "",
      },
      {
        data: "sks_akademik",
        width: "50px",
        className: "text-end align-middle",
        defaultContent: "",
      },
      {
        data: "kode_ruangan",
        width: "75px",
        className: "text-start align-middle",
        defaultContent: "",
      },
      {
        data: "kapasitas",
        width: "50px",
        className: "text-end align-middle",
        defaultContent: "",
      },
      {
        data: "hari",
        width: "100px",
        className: "text-center align-middle",
        defaultContent: "",
      },
      {
        data: "jam_mulai",
        width: "75px",
        className: "text-center align-middle",
        defaultContent: "",
      },
      {
        data: "jam_selesai",
        width: "75px",
        className: "text-center align-middle",
        defaultContent: "",
      },
    ],
    createdRow: function (row, data) {
      $(row)
        .find("td")
        .each(function (index) {
          let columnData = jadwal_tab.column(index).dataSrc();
          if (columnData === null) return;

          if (columnData === "kode_dosen" && data[columnData] != "AS") {
            $(this).html(
              `<input type="text" class="form-control bg-warning" value="${
                data[columnData] || ""
              }" onclick="function($(this))" onkeydown="function(event, $(this))" />`
            );
          } else if (columnData === "kode_ruangan") {
            $(this).html(
              `<input type="text" class="form-control bg-warning" value="${
                data[columnData] || ""
              }" onclick="function($(this))" onkeydown="function(event, $(this))" />`
            );
          } else if (columnData === "hari") {
            $(this).html(
              `<input type="text" class="form-control" value="${
                data[columnData] || ""
              }" onclick="function($(this))" onkeydown="function(event, $(this))" />`
            );
          } else if (columnData === "jam_mulai") {
            $(this).html(
              `<input type="text" class="form-control" value="${
                data[columnData] || ""
              }" onclick="function($(this))" onkeydown="function(event, $(this))" />`
            );
          }
        });
    },
  });
</script>
{% endblock %}
