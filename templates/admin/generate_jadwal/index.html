{% extends "layout.html" %} {% block content %}
<style>
  .circle-checkbox {
    display: inline-block;
    position: relative;
    cursor: pointer;
    width: 24px;
    height: 24px;
  }

  .circle-checkbox input {
    opacity: 0;
    width: 0;
    height: 0;
  }

  .checkmark {
    position: absolute;
    top: 0;
    left: 0;
    height: 24px;
    width: 24px;
    border-radius: 50%;
    background-color: #dc3545; /* merah default */
    background-image: url("data:image/svg+xml,%3Csvg viewBox='0 0 24 24' fill='white' xmlns='http://www.w3.org/2000/svg'%3E%3Cpath d='M18.3 5.7L12 12l6.3 6.3-1.4 1.4L12 13.4l-6.3 6.3-1.4-1.4L10.6 12 4.3 5.7 5.7 4.3 12 10.6 18.3 4.3z'/%3E%3C/svg%3E");
    background-repeat: no-repeat;
    background-position: center;
    background-size: 60%;
    transition: all 0.2s;
  }

  .circle-checkbox input:checked + .checkmark {
    background-color: #28a745; /* hijau */
    background-image: url("data:image/svg+xml,%3Csvg viewBox='0 0 24 24' fill='white' xmlns='http://www.w3.org/2000/svg'%3E%3Cpath d='M9 16.2l-3.5-3.5-1.4 1.4L9 19 20.3 7.7l-1.4-1.4z'/%3E%3C/svg%3E");
  }
</style>

<div class="container-fluid mt-4" id="main-window">
  <div class="card">
    <div class="card-body row align-items-center">
      <!-- Label -->
      <div class="col-12 col-md-5">
        <label class="form-label">
          Jadwal Semester {{ ' '.join(semester_ajaran_depan.split('_')) }}
        </label>
      </div>

      <!-- Tombol -->
      <div class="col-12 col-md-7">
        <div class="row g-2 justify-content-end">
          <!-- Button 1: selalu di atas -->
          <div class="col-12 col-lg-4 order-1" id="div_generate">
            <button
              type="button"
              class="btn btn-primary w-100"
              onclick="generate_jadwal()"
            >
              Generate
            </button>
          </div>

          <!-- Button 2: di bawah untuk <992, sejajar untuk ≥992 -->
          <div class="col-6 col-lg-4 order-2 order-lg-2">
            <button
              type="button"
              class="btn btn-success w-100"
              onclick="download_excel_by()"
            >
              Download Excel
            </button>
          </div>

          <!-- Button 3: di bawah untuk <992, sejajar untuk ≥992 -->
          <div class="col-6 col-lg-4 order-3 order-lg-3">
            <button
              type="button"
              class="btn btn-info w-100"
              onclick="evaluate_jadwal()"
              id="btn_eval"
            >
              Eval Jadwal
            </button>
            <button
              type="button"
              class="btn btn-secondary w-100"
              onclick="switch_display()"
              id="btn_kembali"
              hidden
            >
              Kembali
            </button>
          </div>
        </div>
      </div>
    </div>
  </div>

  <div class="card-wrapper" id="setting_prodi_done"></div>

  <div class="card" id="detail_evaluasi" hidden>
    <div class="card-body">
      <div class="form-group row align-items-center">
        <label
          for="score"
          class="col col-sm-5 col-md-4 col-lg-3 col-xl-2 col-xxl-2"
          >Skor Jadwal</label
        >
        <div class="col-3 col-sm-2 col-md-1">
          <input
            type="text"
            class="form-control text-end"
            id="score"
            disabled
          />
        </div>
        <span class="col"> / 1000</span>
      </div>
      <div class="form-group row align-items-center">
        <label
          for="count_dosen_kosong"
          class="col-12 col-sm-5 col-md-4 col-lg-3 col-xl-2 col-xxl-2"
          >Jumlah Dosen Tidak Mengajar</label
        >
        <div class="col-2 col-sm-2 col-md-1">
          <input
            type="text"
            class="form-control text-end"
            id="count_dosen_kosong"
            disabled
          />
        </div>
      </div>
      <div
        class="form-group row align-items-center fully-disabled"
        id="field_dosen"
      >
        <label
          for="input_dosen"
          class="col-12 col-sm-5 col-md-4 col-lg-3 col-xl-2 col-xxl-2 col-form-label"
          >Dosen Tidak Mengajar</label
        >
        <div class="col" id="list_dosen"></div>
      </div>
      <div class="form-group row align-items-center">
        <label
          for="bentrok_dosen"
          class="col-12 col-sm-5 col-md-4 col-lg-3 col-xl-2 col-xxl-2"
          >Dosen Bertabrakan</label
        >
        <div class="col-2 col-sm-2 col-md-1">
          <input
            type="text"
            class="form-control text-end"
            id="bentrok_dosen"
            disabled
          />
        </div>
      </div>
      <div class="form-group row align-items-center">
        <label
          for="bentrok_ruangan"
          class="col-12 col-sm-5 col-md-4 col-lg-3 col-xl-2 col-xxl-2"
          >Ruangan Bertabrakan</label
        >
        <div class="col-2 col-sm-2 col-md-1">
          <input
            type="text"
            class="form-control text-end"
            id="bentrok_ruangan"
            disabled
          />
        </div>
      </div>
      <div class="form-group row align-items-center">
        <label
          for="bentrok_dosen_asdos"
          class="col-12 col-sm-5 col-md-4 col-lg-3 col-xl-2 col-xxl-2"
          >Dosen & Asisten Bertabrakan</label
        >
        <div class="col-2 col-sm-2 col-md-1">
          <input
            type="text"
            class="form-control text-end"
            id="bentrok_dosen_asdos"
            disabled
          />
        </div>
      </div>
      <div class="form-group row align-items-center">
        <label
          for="solo_team_teaching"
          class="col-12 col-sm-5 col-md-4 col-lg-3 col-xl-2 col-xxl-2"
          >Solo Team Teaching</label
        >
        <div class="col-2 col-sm-2 col-md-1">
          <input
            type="text"
            class="form-control text-end"
            id="solo_team_teaching"
            disabled
          />
        </div>
      </div>
      <div class="align-items-center">
        <label for="table_pelanggaran_preferensi"
          >Pelanggaran Preferensi Dosen</label
        >
        <div class="table-responsive">
          <table
            class="table table-bordered table-stripped table-hover w-100"
            id="table_pelanggaran_preferensi"
          >
            <thead>
              <th>NIP</th>
              <th>Kode Matkul</th>
              <th>Hari</th>
              <th>Jam Mulai</th>
              <th>Jam Selesai</th>
            </thead>
            <tbody></tbody>
          </table>
        </div>
      </div>
    </div>
  </div>
</div>
{% endblock %} {% block script %}
<script>
  const semester_ajaran_depan = "{{ semester_ajaran_depan | safe }}";
  const prodi = "{{ prodi | safe }}";
  var jadwal = "{{ jadwal | safe }}";

  $(document).ready(async function () {
    await setting_prodi_done();
  });

  function setting_prodi_done() {
    $.ajax({
      type: "GET",
      url: "/generate_jadwal/get_simpanan_prodi",
      cache: false,
      beforeSend: () => {
        showLoading();
      },
      complete: () => {
        hideLoading();
      },
      success: async function (res) {
        await res.data.forEach((prodi) => {
          isChecked = prodi.status ? "checked" : "";
          $("#setting_prodi_done").append(
            `<div class="card-responsive d-flex justify-content-between align-items-center fully-disabled">
              <div class="text-label"><label for="${prodi.prodi}">${prodi.prodi}</label></div>
                <div class="button-group"><label class="circle-checkbox">
                  <input type="checkbox" name="prodi_ready" id="${prodi.prodi}" ${isChecked}/>
                  <span class="checkmark"></span>
                </label></div>
              </div>`
          );
        });
      },
    });
  }

  async function generate_jadwal(generate_ulang = false) {
    if (!generate_ulang) {
      let unready = [];
      await $('input[name="prodi_ready"]').each(function () {
        if (!this.checked) {
          unready.push(this.id);
        }
      });

      if (unready.length > 0) {
        let lanjut = await Swal.fire({
          icon: "warning",
          title: "Prodi belum mengatur mata kuliah yang akan dibuka!",
          text: unready,
          showDenyButton: true,
          showCancelButton: false,
          confirmButtonText: "Hiraukan dan Cetak!",
          denyButtonText: "Batal Cetak",
        }).then((result) => {
          if (result.isConfirmed) return true;
          else if (result.isDenied) return false;
        });
        console.log(lanjut);

        if (!lanjut) return;
      }
    }

    param = {
      regenerate: generate_ulang,
    };
    $.ajax({
      type: "GET",
      url: "/generate_jadwal/generate",
      data: param,
      cache: false,
      beforeSend: () => {
        showLoading();
      },
      complete: () => {
        hideLoading();
      },
      success: async function (res) {
        console.log("res ajax", res);

        if (res.status) {
          export_to_excel("Jadwal_Kuliah");
          switch_display(res.score);
        } else {
          if (res.reason === "exist") {
            await Swal.fire({
              icon: "info",
              title: "Jadwal sudah pernah dibuat!",
              text: "Apakah mau buat ulang?",
              showDenyButton: true,
              showCancelButton: true,
              confirmButtonText: "Buat Ulang",
              denyButtonText: "Cetak ?",
              cancelButtonText: "Batal",
              confirmButtonColor: "#007bff",
              denyButtonColor: "#28a745",
            }).then((result) => {
              if (result.isConfirmed) {
                return generate_jadwal(true);
              } else if (result.isDenied) {
                return download_excel_by();
              } else {
                return;
              }
            });
          }
          popUpTimer("error", res.message);
        }
      },
    });
  }

  function download_excel_by() {
    Swal.fire({
      title: "Cetak apa?",
      showDenyButton: true,
      showCancelButton: true,
      confirmButtonText: "Jadwal Kuliah",
      denyButtonText: `Jadwal Ruangan`,
      confirmButtonColor: "#007bff",
      denyButtonColor: "#28a745",
    }).then((result) => {
      if (result.isConfirmed) {
        export_to_excel("Jadwal_Kuliah");
      } else if (result.isDenied) {
        export_to_excel("Jadwal_Ruangan");
      }
    });
  }

  /**
   * @returns {link} - link download document
   */
  async function export_to_excel(downloadBy) {
    console.warn("downloading...");
    let filename = downloadBy + "_Semester-" + semester_ajaran_depan;
    console.log(filename);
    try {
      let params = {
        filename: filename,
        downloadBy: downloadBy.toLowerCase(),
      };

      const data = await $.ajax({
        type: "POST",
        url: "/export/export_to_excel",
        data: JSON.stringify(params),
        contentType: "application/json",
        xhrFields: {
          responseType: "blob",
        },
        beforeSend: () => {
          Swal.fire({
            html: `<p><b>Sedang Membuat File Laporan...</b></p><p style="text-align: center;">Jangan menutup halaman ini!</p>`,
            allowOutsideClick: false,
            allowEnterKey: false,
            allowEscapeKey: false,
            showConfirmButton: false,
            willOpen: (_) => {
              $("#modal_loading").modal("show");
            },
          });
        },
        complete: () => {
          $("#modal_loading").modal("hide");
        },
      });

      Swal.fire({
        title: "Sukses!",
        text: "Berhasil Download Laporan",
        icon: "success",
      });

      const url = URL.createObjectURL(data);
      const link = document.createElement("a");

      link.href = url;
      link.download = filename + ".xlsx";
      document.body.appendChild(link);
      link.click();
      document.body.removeChild(link);
    } catch (error) {
      popUpTimer("error", error.status, error.statusText);
    }
  }

  async function evaluate_jadwal() {
    console.log("clicked");
    $.ajax({
      type: "GET",
      url: "/generate_jadwal/evaluate_jadwal",
      cache: false,
      beforeSend: () => {
        showLoading();
      },
      complete: () => {
        hideLoading();
      },
      success: async function (res) {
        console.log("res ajax", res);

        if (res.data) {
          switch_display(res.data);
        } else {
          popUpTimer("error", res.message);
        }
      },
    });
  }

  async function switch_display(data = undefined) {
    console.warn(data);
    $("#setting_prodi_done")[0].toggleAttribute("hidden");
    $("#detail_evaluasi")[0].toggleAttribute("hidden");
    $("#div_generate")[0].toggleAttribute("hidden");
    $("#btn_eval")[0].toggleAttribute("hidden");
    $("#btn_kembali")[0].toggleAttribute("hidden");
    window.scrollTo({ top: 0, behavior: "smooth" });

    $.fn.dataTable
      .tables({
        visible: true,
        api: true,
      })
      .columns.adjust();

    if (!$("#detail_evaluasi").is("[hidden]") && data) {
      await $("#detail_evaluasi input").val("");
      await $("#detail_evaluasi span.badge").remove();
      $("#field_dosen")[0].toggleAttribute("hidden");
      await preferensi_tab.clear().draw(false);

      Object.entries(data).forEach(async ([key, value]) => {
        if (key == "pelanggaran_preferensi") {
          preferensi_tab.rows.add(value).draw(false);
        } else if (key == "solo_team_teaching") {
          $("#" + key).val(Object.keys(value).length);
        } else if (key == "dosen_not_set") {
          $("#count_dosen_kosong").val(value.length);
          if (value.length > 0) {
            $("#field_dosen")[0].toggleAttribute("hidden");
            await value.forEach((kode) => {
              addBadge("field_dosen", "list_dosen", kode);
            });
          } else {
            $("#field_dosen").prop("hidden", true);
          }
        } else {
          $("#" + key).val(value);
        }
      });
      if (data.score < 900) {
        $("#score").addClass("text-danger");
      } else {
        $("#score").removeClass("text-danger");
      }
      // v_toko_tab.ajax.reload(null, false);
    }
  }

  let preferensi_tab = $("#table_pelanggaran_preferensi").DataTable({
    scrollX: true,
    scrollY: "50vh",
    scrollCollapse: true,
    paging: false,
    responsive: true,
    ordering: false,
    info: false,
    columns: [
      {
        data: "kode_dosen",
        defaultContent: "",
      },
      {
        data: "kode_matkul",
        defaultContent: "",
      },
      {
        data: "hari",
        defaultContent: "",
      },
      {
        data: "jam_mulai",
        defaultContent: "",
      },
      {
        data: "jam_selesai",
        defaultContent: "",
      },
    ],
  });
</script>
{% endblock %}
