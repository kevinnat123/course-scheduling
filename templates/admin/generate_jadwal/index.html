{% extends "layout.html" %} {% block content %}
<div class="container-fluid mt-4" id="main-window">
  <div class="card">
    <div class="card-body">
      <button type="button" id="generate" onclick="generate_jadwal()">
        Generate
      </button>
    </div>
  </div>
</div>
{% endblock %} {% block script %}
<script>
  $(document).ready(function () {});

  function generate_jadwal() {
    $.ajax({
      type: "GET",
      url: "/generate_jadwal/generate",
      cache: false,
      beforeSend: () => {
        console.log("beforesend ajax");
        showLoading();
      },
      complete: () => {
        hideLoading();
      },
      success: async function (res) {
        console.log("res ajax", res);

        if (res.status) export_jadwal_to_excel(res.filename, res.data);
        else popUpTimer("error", res.message);
      },
    });
  }

  /**
   * @returns {link} - link download document
   */
  async function export_jadwal_to_excel(filename, jadwal) {
    console.warn("downloading...");
    try {
      let params = {
        filename: filename,
        jadwal: jadwal,
      };

      const data = await $.ajax({
        type: "POST",
        url: "/generate_jadwal/download_excel",
        data: JSON.stringify(params),
        contentType: "application/json",
        xhrFields: {
          responseType: "blob",
        },
        beforeSend: () => {
          Swal.fire({
            html: `<p><b>Sedang Membuat File Laporan...</b></p><p style="text-align: center;">Jangan menutup halaman ini!</p>`,
            allowOutsideClick: false,
            allowEnterKey: false,
            allowEscapeKey: false,
            showConfirmButton: false,
            willOpen: (_) => {
              $("#modal_loading").modal("show");
            },
          });
        },
        complete: () => {
          $("#modal_loading").modal("hide");
        },
      });

      Swal.fire({
        title: "Sukses!",
        text: "Berhasil Download Laporan",
        icon: "success",
      });

      const url = URL.createObjectURL(data);
      const link = document.createElement("a");

      link.href = url;
      link.download = filename + ".xlsx";
      document.body.appendChild(link);
      link.click();
      document.body.removeChild(link);
    } catch (error) {
      popUpTimer("error", error.status, error.statusText);
    }
  }
</script>
{% endblock %}
